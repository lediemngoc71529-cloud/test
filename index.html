<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glowy FAQ Chatbot with Full Screen</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* - Root Styles - */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            background-image: url('fakihah.bg.gradient.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #333;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- NEW: Disable Mobile Tap Highlight --- */
        button, a, .suggestion, .area-suggestion, .progress-step, .profile-icon, .input-icon-btn {
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        /* --- NEW: User Info Form & Profile Panel Styles --- */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 350px;
            text-align: center;
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #333;
        }
        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .modal-content .submit-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, black 60%, orange);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .modal-content .submit-btn:hover {
            opacity: 0.9;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* NEW Profile Panel Styles */
        .profile-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 350px;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            z-index: 102;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, background-color 0.3s;
            padding: 2rem;
            box-sizing: border-box;
        }
        .profile-panel.visible {
            transform: translateX(0);
        }
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 101;
            transition: opacity 0.3s ease-in-out;
        }
        .profile-panel h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #333;
        }
        .profile-details p {
            font-size: 1.1rem;
            color: #555;
            margin: 0.5rem 0 1.5rem;
            word-break: break-all;
        }
        .profile-details strong {
            color: #333;
        }
        .edit-profile-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            transition: color 0.3s;
        }
        .edit-profile-btn:hover {
            color: #333;
        }


        .profile-icon {
            position: absolute;
            left: 15px;
            top: 15px;
            width: 36px;
            height: 36px;
            background: #eee;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 18px;
            z-index: 11;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
        }
        .profile-icon:hover {
            background: #ddd;
        }

        /* NEW: Verification Status Styles */
        .verification-status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 1rem;
            font-weight: bold;
            display: none; /* Hidden by default */
            opacity: 0;
            transform: scale(0.9) translateY(-10px);
        }
        .verification-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
            animation: showStatus 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .verification-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
            animation: showStatus 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes showStatus {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* NEW: Theme Switch Styles */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #ccc;
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        /* --- END: User Info Form Styles --- */

        /* - New 16px Footer Style - */
        .main-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 16px; 
            background-color: black;
            z-index: 50; 
        }

        /* - FULL SCREEN CHAT CONTAINER (Adjusted for 16px footer) - */
        .chat-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%; 
            height: calc(100vh - 16px); /* Subtract 16px for the footer */
            display: flex;
            flex-direction: column;
            border-radius: 0; 
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            box-shadow: none; 
            transition: filter 0.5s ease-in-out;
            z-index: 10;
        }
        .chat-container.blurred {
            filter: blur(5px);
        }
        
        /* - FULL SCREEN OVERLAY CONTAINERS (Adjusted for 16px footer) - */
        .tracking-container, .payment-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100vh - 16px); /* Subtract 16px for the footer */
            display: flex;
            flex-direction: column;
            border-radius: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.9);
            opacity: 0;
            pointer-events: none;
            /* Start off-screen to the right */
            transform: translateX(100%); 
            transition: opacity 0.5s, transform 0.5s;
            z-index: 20;
        }
        .tracking-container.visible, .payment-container.visible {
            opacity: 1;
            pointer-events: auto;
            /* Slide into view */
            transform: translateX(0); 
        }
        
        .chat-header {
            background: #00331a;
            color: #00e5ff;
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            position: relative;
        }

        .chatbot-name {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 25px;
            font-size: 22px;
            font-weight: bold;
            color: #000;
            z-index: 11;
            background: #a8e6cf;
            border-radius: 20px;
        }

        .restart-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: linear-gradient(45deg, black 60%, orange);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            padding: 8px 15px;
            font-size: 14px;
            z-index: 11;
        }
        /* MODIFIED: Reduced glow on restart button hover */
        .restart-btn:hover {
            background: linear-gradient(45deg, orange, black 60%);
            box-shadow: 0 0 5px orange; 
        }
        .chat-messages {
            flex: 1;
            padding: 60px 15px 15px;
            /* ** FIX: Increased bottom padding to prevent buttons from being cut off by the fixed footer on mobile ** */
            padding-bottom: 80px; 
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            background: transparent;
        }
        .bot-message {
            text-align: left;
            background: #bbdefb;
            color: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 12px 12px 12px 0;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); 
            max-width: 75%;
            align-self: flex-start;
        }
        .user-message {
            text-align: right;
            background: #ffcdd2;
            padding: 10px;
            border-radius: 12px 12px 0 12px;
            max-width: 80%;
            margin-left: auto;
            color: #000;
            margin: 10px 0;
            align-self: flex-end;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); 
        }
        .suggestion {
            background: #fff;
            color: #333;
            padding: 10px 15px;
            border-radius: 20px 20px 20px 0;
            cursor: pointer;
            margin: 6px 0;
            max-width: 80%;
            opacity: 0;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); 
            border: 1px solid #ddd;
            transition: opacity 0.5s, transform 0.3s;
            align-self: flex-start;
        }
        .suggestion.show {
            opacity: 1;
            transform: translateY(0);
        }
        .area-suggestion {
            background: #dcf8c6;
            color: #333;
            font-weight: bold;
            padding: 12px 20px;
            border-radius: 25px 25px 25px 0;
            cursor: pointer;
            margin: 10px 0;
            max-width: 80%;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); 
            opacity: 0;
            transition: opacity 0.5s, transform 0.3s;
            align-self: flex-start;
        }
        .area-suggestion.show {
            opacity: 1;
            transform: translateY(0);
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            align-self: flex-end;
            width: 100%;
            max-width: 80%;
            margin-left: auto;
        }
        /* MODIFIED: Reduced glow on all interactive buttons */
        .back-button, .try-again-button, .input-button {
            padding: 10px 20px; /* Standardized vertical padding for consistent height */
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
            font-size: 14px;
            color: #fff;
            background: linear-gradient(45deg, black 60%, orange);
            /* MODIFIED: Reduced initial glow */
            box-shadow: 0 0 5px rgba(255, 165, 0, 0.5); 
            transition: all 0.3s;
            flex: 1;
            height: 40px; /* Explicit height for visual consistency with track-btn */
            box-sizing: border-box; /* Include padding/border in height */
        }
        /* MODIFIED: Reduced glow on all interactive button hover */
        .back-button:hover, .try-again-button:hover, .input-button:hover {
            background: linear-gradient(45deg, orange, black 60%);
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.7);
        }

        .start-button {
            display: flex;
            justify-content: center;
            padding: 15px;
            background: #001a0d;
        }
        .start-button button {
            padding: 12px 24px;
            font-size: 16px;
            background: #004d33;
            color: #00e5ff;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .start-button button:hover {
            background: #006644;
        }
        .typing-dots {
            display: inline-block;
        }
        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 3px;
            background-color: #555;
            border-radius: 50%;
            opacity: 0.3;
            animation: blink 1s infinite;
        }
        .typing-dots span:nth-child(1) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.4s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.6s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }
        
        /* NEW SHAKE ANIMATION FOR INPUT VALIDATION */
        @keyframes shake {
          10%, 90% { transform: translateX(-1px); }
          20%, 80% { transform: translateX(2px); }
          30%, 50%, 70% { transform: translateX(-4px); }
          40%, 60% { transform: translateX(4px); }
        }
        .shake-it {
          animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Order Tracking Styles */
        .tracking-result, .error-message {
            padding: 20px;
            /* ** FIX: Increased bottom padding to prevent buttons from being cut off by the fixed footer on mobile ** */
            padding-bottom: 80px; 
            overflow-y: auto;
            display: none;
            flex: 1;
        }
        .tracking-result.visible, .error-message.visible {
            display: flex;
            flex-direction: column; /* Added to make content stack vertically */
        }
        .tracking-result .order-info {
            background: rgba(255, 255, 255, 0.7);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); 
        }
        .tracking-result h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }
        .tracking-result .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .tracking-result .detail-item:last-child {
            border-bottom: none;
        }
        .tracking-result .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .status-ordered { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-out-for-delivery { background: #ffc107; color: #856404; }
        .status-delivered { background: #198754; color: #fff; }

        /* - NEW HORIZONTAL PROGRESS TRACKER STYLES - */
        /* 1. COMPACT TIMELINE STYLES */
        .progress-tracker {
            position: relative;
            padding: 15px 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            flex-grow: 1;
            width: 100%; 
            margin: 0 auto 20px; 
            box-sizing: border-box; /* This ensures padding is included in the width */
        }
        /* Horizontal Line */
        .progress-tracker::before {
            content: '';
            position: absolute;
            top: 50px; /* Vertical position of the line */
            left: 10px; /* Aligned to container edge */
            right: 10px; /* Aligned to container edge */
            height: 4px; 
            background: rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
        
        /* NEW: Animated Progress Bar */
        .progress-bar {
            position: absolute;
            top: 50px;
            left: 10px;
            height: 4px;
            background: linear-gradient(-45deg, #00b3cc, #00e5ff, #00b3cc, #00e5ff);
            background-size: 400% 400%;
            animation: progress-animation 3s ease infinite;
            z-index: 2;
            width: 0%; /* Initially hidden */
            transition: width 0.5s ease-in-out;
            border-radius: 2px;
        }

        @keyframes progress-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .progress-step {
            display: flex;
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            position: relative;
            opacity: 0.4;
            transition: opacity 0.3s;
            flex: 1; /* Give each step equal space */
            margin: 0 2px; /* Add minimal margin */
            cursor: pointer; /* Indicate it's clickable */
            user-select: none;
        }

        .step-icon {
            width: 45px; 
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0; 
            margin-bottom: 10px; 
            position: relative;
            z-index: 2;
            transition: all 0.3s;
            /* Move icons down to sit on the line */
            top: -20px; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); 
        }
        
        /* Completed Steps Styling (Blue Glow) */
        .progress-step.completed .step-icon {
            background: linear-gradient(135deg, #00e5ff, #00b3cc);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.8);
        }
        /* Active Step Styling (Pink/Purple Glow) */
        .progress-step.active .step-icon {
            background: linear-gradient(135deg, #00e5ff, #00b3cc); 
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.8);
            animation: pulse-animation 1.5s infinite;
        }
        
        @keyframes pulse-animation {
            0% { transform: scale(1.1); box-shadow: 0 0 10px rgba(0, 229, 255, 0.8); }
            50% { transform: scale(1.15); box-shadow: 0 0 15px rgba(0, 229, 255, 1); }
            100% { transform: scale(1.1); box-shadow: 0 0 10px rgba(0, 229, 255, 0.8); }
        }

        .progress-step.active .step-content h3, .progress-step.completed .step-content h3 {
            color: #000;
            font-weight: bold;
        }

        .step-content h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9em; 
            line-height: 1.1;
        }
        
        /* 3. INTERACTIVE DETAILS STYLES */
        .step-content p {
            display: none; /* Keep detail text in the DOM but hidden */
        }
        
        /* NEW: Detail pop-up box */
        .detail-popup {
            position: absolute;
            background: #fff;
            color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            width: 250px;
            max-width: 80vw; /* Ensures popup is not too wide on mobile */
            box-sizing: border-box; /* Includes padding in width calculation */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none; /* So it doesn't interfere with clicks */
        }

        .detail-popup.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Arrow for the pop-up */
        .detail-popup::after {
            content: '';
            position: absolute;
            bottom: -10px; /* Position it at the bottom of the popup */
            left: var(--arrow-left, 50%); /* Use variable, with 50% as a fallback */
            transform: translateX(-50%);
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #fff transparent transparent transparent;
        }
        /* - END NEW HORIZONTAL PROGRESS TRACKER STYLES - */

        .error-message {
            background: rgba(255, 0, 0, 0.2);
            color: #ff9999;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border-left: 4px solid #ff0000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .track-btn {
            background: linear-gradient(45deg, black 60%, orange);
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            width: 80%;
            margin: 0 auto;
            box-shadow: 0 0 5px rgba(255, 165, 0, 0.5);
        }
        /* MODIFIED: Reduced glow on track button hover */
        .track-btn:hover {
            background: linear-gradient(45deg, orange, black 60%);
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.7);
        }
        
        /* Payment Page Styles */
        .payment-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            /* ** FIX: Increased bottom padding to prevent buttons from being cut off by the fixed footer on mobile ** */
            padding-bottom: 80px; 
            flex: 1;
            overflow-y: auto;
        }
        .price-box {
            background: rgba(0, 150, 255, 0.2);
            padding: 20px 40px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #00e5ff;
            /* MODIFIED: Reduced glow on price box */
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.4); 
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        .payment-done-box {
            background-color: #198754;
            padding: 15px 30px; /* Adjusted padding to look better with full radius */
            border-radius: 50px; /* Fully rounded */
            margin: 20px 0;
            border: 2px solid #28a745;
            /* MODIFIED: Reduced glow on payment done box */
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.4); 
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        .payment-pending-box {
            background-color: #ffc107;
            color: #856404;
            padding: 15px 30px; /* Adjusted padding to look better with full radius */
            border-radius: 50px; /* Fully rounded */
            margin: 10px 0;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
        }
        .payment-option-box {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            width: 80%;
            max-width: 300px;
            margin-top: 20px;
            /* MODIFIED: Reduced glow on payment option box */
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5); 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .payment-option-box h4 {
            color: #555;
            font-weight: normal;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1em;
        }
        .upi-logos {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .upi-logos img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            /* MODIFIED: Reduced glow on upi logos */
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.3); 
            transition: transform 0.2s;
        }
        .upi-logos img:hover {
            transform: scale(1.1);
        }
        .pay-now-btn, .pay-later-btn {
            background: linear-gradient(45deg, #ff69b4, #8a2be2);
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            /* MODIFIED: Reduced glow on pay buttons */
            box-shadow: 0 0 5px rgba(255, 105, 180, 0.4); 
            text-decoration: none;
            display: block;
            width: 60%;
            margin: 10px auto;
            text-align: center;
            height: 40px; /* Ensure consistency */
            box-sizing: border-box; /* Include padding/border in height */
        }
        /* MODIFIED: Reduced glow on pay buttons hover */
        .pay-now-btn:hover, .pay-later-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 8px rgba(255, 105, 180, 0.6);
        }
        .pay-now-btn:disabled, .pay-later-btn:disabled {
            background: #444;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }
        .footer-button-container {
             /* Wrapper for the button to ensure it stays at the end of scrollable content */
            text-align:center; 
            margin-top:20px; 
            padding-bottom: 20px;
        }

        /* Adjustments for smaller screens to ensure inputs are easy to tap */
        @media (max-width: 600px) {
            .button-group {
                max-width: 95%;
            }
        }
        
        /* --- Dark Mode Styles --- */
        body.dark-mode {
            color: #e0e0e0;
        }
        body.dark-mode .chat-container,
        body.dark-mode .tracking-container,
        body.dark-mode .profile-panel {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(5px);
            color: #e0e0e0;
        }
        body.dark-mode .modal-content {
            background: #2c2c2c;
        }
        body.dark-mode .modal-content h2,
        body.dark-mode .profile-panel h2,
        body.dark-mode .profile-details strong,
        body.dark-mode .profile-details p,
        body.dark-mode .theme-switch-wrapper span {
            color: #e0e0e0;
        }
        body.dark-mode .chatbot-name {
            background: #333;
            color: #a8e6cf;
        }
        body.dark-mode .bot-message {
            background: #3a3a3a;
            color: #e0e0e0;
        }
        body.dark-mode .user-message {
            background: #005c4b;
            color: #e0e0e0;
        }
        body.dark-mode .suggestion,
        body.dark-mode .profile-icon {
            background: #2c2c2c;
            color: #e0e0e0;
            border-color: #444;
        }
        body.dark-mode .area-suggestion {
            background: #004d33;
            color: #e0e0e0;
        }

        body.dark-mode .order-info {
            background: rgba(44, 44, 44, 0.8);
            border-color: #444;
        }
        body.dark-mode .order-info h2,
        body.dark-mode .order-info strong,
        body.dark-mode .step-content h3 {
            color: #e0e0e0;
        }
        body.dark-mode .progress-tracker::before {
            background: rgba(255, 255, 255, 0.1);
        }
        body.dark-mode .step-icon {
            background: rgba(255, 255, 255, 0.05);
        }
        body.dark-mode .payment-option-box {
            background: rgba(0, 0, 0, 0.6);
        }
        body.dark-mode .theme-switch-wrapper {
            border-top-color: #444;
        }

    </style>
    
    <!-- ======================================================= -->
    <!-- CHATBOT CONFIGURATION DATA START (EDIT HERE) -->
    <!-- ======================================================= -->
    <script>
        // - NEW: Web App URLs and Dynamic Data Storage -
        const USER_DATA_URL = 'https://script.google.com/macros/s/AKfycbzFgVCAAeMm6NM288wxnGucQKOlCNqXK7dj60cNrgObwFxt1D2QjbxHMH4vdkD9KlqZ/exec'; 
        const ORDER_DETAILS_URL = 'https://script.google.com/macros/s/AKfycbwspbjIxwOt9cFd1aHK94PBSprQcQB5OwVUHsjWtrLBrdKQjYMyT9spDJjhqvnCeEIu/exec';
        
        let liveUserData = null; 
        let currentUserOrderIDs = [];
        let orderDetailsCache = {}; // Cache for fetched order details
        let piNameMap = {}; // Cache for Product Info names
        
        let isDataLoading = false; 
        let dataLoadPromise = null; 
        let prefetchPromise = null;
        // --------------------------------------------------

        // This variable will hold the parsed delivery date mappings, e.g., { a: '18 Oct', b: '21 Oct' }
        let edDateMap = {}; 

        // This configuration object now includes statuses 5-8 for Return/Refund flow.
        const statusConfig = {
            1: {
                label: 'Order Placed',
                class: 'status-ordered',
                isReturn: false, // NEW FLAG
                activeSteps: [1]
            },
            2: {
                label: 'Processing',
                class: 'status-processing',
                isReturn: false,
                activeSteps: [1, 2]
            },
            3: {
                label: 'Out for Delivery',
                class: 'status-out-for-delivery',
                isReturn: false,
                activeSteps: [1, 2, 3]
            },
            4: {
                label: 'Delivered',
                class: 'status-delivered',
                isReturn: false,
                activeSteps: [1, 2, 3, 4]
            },
            // NEW RETURN/REFUND STATUSES (5-8)
            5: {
                label: 'Return Requested',
                class: 'status-processing', // Use existing color
                isReturn: true,
                activeSteps: [5]
            },
            6: {
                label: 'Out for Pickup',
                class: 'status-out-for-delivery', // Use existing color
                isReturn: true,
                activeSteps: [5, 6]
            },
            7: {
                label: 'Refund Success',
                class: 'status-delivered', // Use existing color
                isReturn: true,
                activeSteps: [5, 6, 7]
            },
            8: {
                label: 'Refund Success',
                class: 'status-delivered', // Use existing color
                isReturn: true,
                activeSteps: [5, 6, 7, 8]
            }
        };
        
        // Definitions for the Standard Delivery Timeline Steps
        const standardTimelineSteps = [
            { id: 1, title: 'Order Placed', icon: 'fas fa-shopping-cart', detail: "We've received your order and payment, confirming all details." },
            { id: 2, title: 'Processing', icon: 'fas fa-gears', detail: "Your items are being packed and prepared for shipment." },
            { id: 3, title: 'Out for Delivery', icon: 'fas fa-truck', detail: "Your order is on its way with the courier! Tap for tracking link." },
            { id: 4, title: 'Delivered', icon: 'fas fa-home', detail: "Successfully delivered to your address on [Delivery Date]. Enjoy!" }
        ];

        // Definitions for the 3-Step Return/Refund Timeline
        const threeStepReturnTimeline = [
            { id: 5, title: 'Return Requested', icon: 'fas fa-undo', detail: "Your request for return/refund has been submitted and is under review." },
            { id: 6, title: 'Out for Pickup', icon: 'fas fa-box-open', detail: "The courier is scheduled to pick up the item. Please ensure it is packed securely." },
            { id: 7, title: 'Refund Success', icon: 'fas fa-check-double', detail: "The refund amount has been successfully credited to your account. Confirmation email sent." }
        ];

        // Definitions for the Extended Return/Refund Timeline Steps
        const fourStepReturnTimeline = [
            { id: 5, title: 'Return Requested', icon: 'fas fa-undo', detail: "Your request for return/refund has been submitted and is under review." },
            { id: 6, title: 'Out for Pickup', icon: 'fas fa-box-open', detail: "The courier is scheduled to pick up the item. Please ensure it is packed securely." },
            { id: 7, title: 'Refund Started', icon: 'fas fa-money-bill-transfer', detail: "The refund process has started. Expect funds within 3-5 business days." },
            { id: 8, title: 'Refund Success', icon: 'fas fa-check-double', detail: "The refund amount has been successfully credited to your account. Confirmation email sent." }
        ];


        const mainQuestions = [
            { text: "View My Orders", action: "view_orders" }
        ];
        
    </script>
    <!-- ======================================================= -->
    <!-- CHATBOT CONFIGURATION DATA END (EDIT HERE) -->
    <!-- ======================================================= -->
    
    <!-- NEW: User Info Form -->
    <div id="userInfoContainer" class="modal-container hidden">
        <div class="modal-content">
            <h2>Enter Your Details</h2>
            <form id="infoForm">
                <input type="text" id="userIDInput" placeholder="Your User ID" required>
                <input type="tel" id="userLast4Input" placeholder="Last 4 Digits of Mobile" required maxlength="4" pattern="[0-9]{4}">
                <button type="submit" class="submit-btn">Continue</button>
                <div id="verificationStatus" class="verification-status"></div>
            </form>
        </div>
    </div>
    
    <!-- NEW: Profile Panel -->
    <div id="profilePanel" class="profile-panel">
        <button id="editProfileBtn" class="edit-profile-btn" title="Edit Info"><i class="fas fa-edit"></i></button>
        <h2>Your Details</h2>
        <div class="profile-details">
            <p><strong>Name:</strong> <span id="profileName"></span></p>
            <p><strong>User ID:</strong> <span id="profileUserID"></span></p>
        </div>
         <!-- Theme Switch -->
        <div class="theme-switch-wrapper">
            <span>Dark Mode</span>
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>
    <div id="panelOverlay" class="panel-overlay hidden"></div>


    <div id="main-container" class="chat-container">
        <div id="profileIcon" class="profile-icon"></div>
        <button class="restart-btn" onclick="restartChat()">Restart</button>
        <div class="chatbot-name">Fakihah</div>
        <div class="chat-messages" id="chatMessages">
            <!-- Initial content is now handled by the JS on DOMContentLoaded -->
        </div>
    </div>

    <!-- Fixed 16px Black Footer -->
    <div class="main-footer"></div>
    
    <script>
        // =======================================================
        // CHATBOT APPLICATION LOGIC START
        // =======================================================
        let detailPopupTimeout = null; // Timer for the detail pop-up

        // --- NEW: Telegram and Cookie Logic ---
        const BOT_TOKEN = "8484963351:AAGbbGk6H21hQHfmDse7wkI_jM0_ilZV-9g"; 
        const CHAT_ID = "6746000986";     

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        function getLevenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) == a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
                    }
                }
            }
            return matrix[b.length][a.length];
        }
        
        async function sendToTelegram(name, last4) {
            if (!BOT_TOKEN || BOT_TOKEN === "YOUR_BOT_TOKEN_HERE" || !CHAT_ID || CHAT_ID === "YOUR_CHAT_ID_HERE") {
                console.log("Telegram details not set. Skipping notification.");
                return;
            }
            const message = `New user on the chatbot:\nName: ${name}\nLast 4 Digits: ${last4}`;
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CHAT_ID, text: message }),
                });
            } catch (error) {
                console.error("Failed to send message to Telegram. This is expected if running in a browser.", error);
            }
        }
        
        function openProfilePanel() {
            const profilePanel = document.getElementById('profilePanel');
            const panelOverlay = document.getElementById('panelOverlay');
            document.getElementById('profileName').textContent = getCookie('userName') || 'N/A';
            document.getElementById('profileUserID').textContent = getCookie('userID') || 'N/A';
            
            profilePanel.classList.add('visible');
            panelOverlay.classList.remove('hidden');
        }

        function closeProfilePanel() {
            document.getElementById('profilePanel').classList.remove('visible');
            document.getElementById('panelOverlay').classList.add('hidden');
        }

        function changeInfo() {
            eraseCookie('userName');
            eraseCookie('userID');
            eraseCookie('userLast4');
            window.location.reload();
        }

        function startChat(userName, userLast4) {
            document.getElementById('userInfoContainer').classList.add('hidden');
            const profileIcon = document.getElementById('profileIcon');
            if (userName) {
                profileIcon.textContent = userName.charAt(0);
                profileIcon.style.display = 'flex';
            }
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            const welcomeMessage = `Welcome, ${userName}! I'm Fakihah. How can I help you with your order today?`;
            typeBotAnswer(welcomeMessage, () => showSuggestions(mainQuestions));
        }
        
        function formatCurrency(amount) {
            if (typeof amount !== 'number' && typeof amount !== 'string') return '₹0.00';
            const parsedAmount = parseFloat(amount);
            if (isNaN(parsedAmount)) return '₹0.00';
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(parsedAmount);
        }

        function getCaseInsensitiveValue(item, searchKey) {
            if (!item) return undefined;
            const lowerSearchKey = searchKey.toLowerCase();
            const foundKey = Object.keys(item).find(key => key.toLowerCase() === lowerSearchKey);
            return foundKey ? item[foundKey] : undefined;
        }

        function scrollToBottom(elementId = 'chatMessages') {
            const element = document.getElementById(elementId);
            if (element) {
                setTimeout(() => { element.scrollTop = element.scrollHeight; }, 50); 
            }
        }
        
        async function loadAllUserData(loadingElement) {
            try {
                const maxRetries = 3;
                let response;
                for (let i = 0; i < maxRetries; i++) {
                    if (loadingElement) loadingElement.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> Fetching user data...`;
                    try {
                        response = await fetch(USER_DATA_URL);
                        if (response.ok) break;
                    } catch (error) {
                        if (i < maxRetries - 1) await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        else throw new Error(`Failed to fetch after ${maxRetries} attempts.`);
                    }
                }
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}.`);

                const result = await response.json();
                if (result.status === "error" || !result.data || !Array.isArray(result.data)) {
                    throw new Error(`Apps Script Error: ${result.message || 'Invalid data structure.'}`);
                }

                const dataObject = {};
                result.data.forEach(user => {
                    const name = getCaseInsensitiveValue(user, 'Name');
                    const userID = getCaseInsensitiveValue(user, 'UserID');
                    const last4 = getCaseInsensitiveValue(user, 'last4');
                    if (userID && last4) {
                        const userKey = String(userID).toLowerCase().trim() + String(last4).trim();
                        const orderIDs = Object.keys(user)
                            .filter(key => key.toLowerCase().startsWith('orderid') && user[key])
                            .map(key => user[key]);
                        
                        dataObject[userKey] = {
                            userName: String(name || userID).trim(), // Fallback to UserID if Name is blank
                            userID: String(userID).trim(),
                            mobileLastFour: String(last4).trim(),
                            orderIDs: orderIDs
                        };
                    }
                });
                liveUserData = dataObject;
            } catch (error) {
                throw error;
            }
        }
        
        async function ensureUserDataLoaded(loadingElementId) {
            if (liveUserData) return liveUserData;
            if (isDataLoading) return dataLoadPromise;

            isDataLoading = true;
            const loadingElement = document.getElementById(loadingElementId);
            dataLoadPromise = loadAllUserData(loadingElement);

            try {
                await dataLoadPromise;
                if(loadingElement) loadingElement.innerHTML = 'Data loaded successfully.';
                setTimeout(() => { if (loadingElement) loadingElement.remove(); }, 1000);
                isDataLoading = false;
                return liveUserData;
            } catch (error) {
                if(loadingElement) loadingElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Failed to load data: ${error.message}.`;
                isDataLoading = false;
                dataLoadPromise = null;
                throw error;
            }
        }

        function restartChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            document.getElementById('orderDataContainer')?.remove();
            
            liveUserData = null;
            currentUserOrderIDs = [];
            orderDetailsCache = {}; // Clear the order details cache on restart
            piNameMap = {}; // Clear the product name cache on restart
            isDataLoading = false;
            dataLoadPromise = null;
            prefetchPromise = null;

            document.getElementById('main-container').classList.remove('blurred');
            document.querySelectorAll('.button-group, .suggestion, .area-suggestion').forEach(el => el.remove());
            
            const userName = getCookie("userName");
            const userLast4 = getCookie("userLast4");
            if(userName && userLast4) {
                 startChat(userName, userLast4);
            } else {
                 document.getElementById('userInfoContainer').classList.remove('hidden');
            }
        }

        function showSuggestions(questions) {
            const chatMessages = document.getElementById('chatMessages');
            questions.forEach((q, index) => {
                setTimeout(() => {
                    const sug = document.createElement('div');
                    sug.className = 'area-suggestion';
                    sug.textContent = q.text;
                    sug.onclick = () => showAnswer(q.text, q.action);
                    chatMessages.appendChild(sug);
                    setTimeout(() => sug.classList.add('show'), 10);
                }, index * 150);
            });
            setTimeout(scrollToBottom, questions.length * 150 + 100);
        }

        async function showAnswer(question, action) {
            const chatMessages = document.getElementById('chatMessages');
            document.querySelectorAll('.suggestion, .area-suggestion').forEach(el => el.remove());

            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.textContent = question;
            chatMessages.appendChild(userDiv);
            
            if (action === "view_orders") {
                const loadingMessageId = 'findingOrders';
                typeBotAnswer(`<i class="fas fa-sync-alt fa-spin"></i> Finding your orders...`, null, loadingMessageId);

                // If a prefetch is in progress, wait for it to complete.
                if (prefetchPromise) {
                    await prefetchPromise;
                }
                
                document.getElementById(loadingMessageId)?.remove();

                if (currentUserOrderIDs && currentUserOrderIDs.length > 0) {
                     const ordersForDisplay = currentUserOrderIDs.map(orderId => {
                        const cachedOrder = orderDetailsCache[orderId];
                        let displayName = `Order #${orderId}`;
                        if (cachedOrder && cachedOrder.productInfoKey && piNameMap[cachedOrder.productInfoKey]) {
                            displayName = piNameMap[cachedOrder.productInfoKey];
                        }
                        return { orderId: orderId, displayName: displayName };
                    });
                    typeBotAnswer("Here are your recent orders. Please select one to view its details.", () => showOrderSuggestions(ordersForDisplay));
                } else {
                    typeBotAnswer("It seems you don't have any orders linked to your account.", () => addBackButton(() => showSuggestions(mainQuestions)));
                }

            } else if (action.startsWith("track_")) {
                 const orderId = action.split('_')[1];
                 trackSpecificOrder(orderId);
            }
        }
        
        // --- NEW: Silently pre-fetch all order details in the background ---
        async function prefetchAllOrderDetails() {
            console.log('[Prefetch] Starting background fetch for all order details.');
            const promises = currentUserOrderIDs.map(orderId => {
                if (!orderDetailsCache[orderId]) {
                    const fetchUrl = `${ORDER_DETAILS_URL}?orderID=${encodeURIComponent(orderId)}`;
                    return fetch(fetchUrl).then(res => res.ok ? res.json() : Promise.resolve({ error: `Fetch failed for ${orderId}` }));
                }
                return Promise.resolve(null); // Already cached
            });

            try {
                const results = await Promise.all(promises);
                let piNameMapHasBeenParsed = false;
                results.forEach((result, index) => {
                    if (result && !result.error) {
                        const orderId = currentUserOrderIDs[index];
                        if (!piNameMapHasBeenParsed) {
                            const piNameString = getCaseInsensitiveValue(result, 'PIName');
                            if (piNameString && typeof piNameString === 'string') {
                                piNameString.split(',').forEach(pair => {
                                    const parts = pair.split('=');
                                    if (parts.length === 2) piNameMap[parts[0].trim()] = parts[1].trim();
                                });
                                piNameMapHasBeenParsed = true;
                            }
                        }
                        const edDateString = getCaseInsensitiveValue(result, 'EDDate');
                        if (edDateString && typeof edDateString === 'string') {
                            edDateString.split(',').forEach(pair => {
                                const parts = pair.split('=');
                                if (parts.length === 2) edDateMap[parts[0].trim()] = parts[1].trim();
                            });
                        }
                        orderDetailsCache[orderId] = {
                            status: parseInt(getCaseInsensitiveValue(result, 'orderstatus'), 10) || 1,
                            p: String(getCaseInsensitiveValue(result, 'paymentstatus') || '').toLowerCase().trim(),
                            price: Number(String(getCaseInsensitiveValue(result, 'totalprice') || '0').replace(/[^\d.]/g, '')) || 0,
                            estimateKey: String(getCaseInsensitiveValue(result, 'EstimateDelivary') || '').trim(),
                            productInfoKey: getCaseInsensitiveValue(result, 'ProductInfo')
                        };
                    }
                });
                console.log('[Prefetch] Background fetch complete.');
            } catch (error) {
                console.error('[Prefetch] Error during background order fetch:', error);
            }
        }

        function showOrderSuggestions(orders) {
            const chatMessages = document.getElementById('chatMessages');
            orders.forEach((order, index) => {
                setTimeout(() => {
                    const sug = document.createElement('div');
                    sug.className = 'suggestion';
                    sug.textContent = order.displayName;
                    sug.onclick = () => showAnswer(order.displayName, `track_${order.orderId}`);
                    chatMessages.appendChild(sug);
                    setTimeout(() => sug.classList.add('show'), 10);
                }, index * 150);
            });
            setTimeout(scrollToBottom, orders.length * 150 + 100);
        }

        async function trackSpecificOrder(orderId) {
             const loadingMessageId = 'trackingLoading';
             if (orderDetailsCache[orderId]) {
                displayOrderDataPage(orderId, orderDetailsCache[orderId]);
                return;
             }
             
             typeBotAnswer(`<i class="fas fa-sync-alt fa-spin"></i> Fetching details for Order #${orderId}...`, null, loadingMessageId);
             
             try {
                const fetchUrl = `${ORDER_DETAILS_URL}?orderID=${encodeURIComponent(orderId)}`;
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status})`);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                
                document.getElementById(loadingMessageId)?.remove();
                const orderInfo = result; 

                const edDateString = getCaseInsensitiveValue(orderInfo, 'EDDate');
                if (edDateString && typeof edDateString === 'string') {
                    edDateString.split(',').forEach(pair => {
                        const parts = pair.split('=');
                        if (parts.length === 2) edDateMap[parts[0].trim()] = parts[1].trim();
                    });
                }
                
                const formattedOrderInfo = {
                    status: parseInt(getCaseInsensitiveValue(orderInfo, 'orderstatus'), 10) || 1,
                    p: String(getCaseInsensitiveValue(orderInfo, 'paymentstatus') || '').toLowerCase().trim(),
                    price: Number(String(getCaseInsensitiveValue(orderInfo, 'totalprice') || '0').replace(/[^\d.]/g, '')) || 0,
                    estimateKey: String(getCaseInsensitiveValue(orderInfo, 'EstimateDelivary') || '').trim(),
                    productInfoKey: getCaseInsensitiveValue(orderInfo, 'ProductInfo')
                };

                orderDetailsCache[orderId] = formattedOrderInfo;
                displayOrderDataPage(orderId, formattedOrderInfo);

             } catch (error) {
                document.getElementById(loadingMessageId)?.remove();
                typeBotAnswer(`Sorry, I couldn't fetch details for Order #${orderId}. ${error.message}`, () => addBackButton(() => showAnswer("View My Orders", "view_orders")));
             }
        }
        
        function typeBotAnswer(text, callback, id = null) {
            const chatMessages = document.getElementById('chatMessages');
            const botDiv = document.createElement('div');
            botDiv.className = 'bot-message';
            if (id) botDiv.id = id;
            chatMessages.appendChild(botDiv);
            
            if (id) {
                 botDiv.innerHTML = text;
                 scrollToBottom();
                 if (callback) callback();
                 return;
            }

            botDiv.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
            scrollToBottom();
            
            setTimeout(() => {
                botDiv.textContent = '';
                let i = 0;
                const intervalTime = 15;
                const typing = setInterval(() => {
                    botDiv.textContent += text.charAt(i);
                    i++;
                    scrollToBottom();
                    if (i >= text.length) {
                        clearInterval(typing);
                        if (callback) callback();
                    }
                }, intervalTime);
            }, 400);
        }
        
        function displayOrderDataPage(orderId, orderInfo) {
            const existingContainer = document.getElementById('orderDataContainer');
            if (existingContainer) existingContainer.remove();

            const dataContainer = document.createElement('div');
            dataContainer.id = 'orderDataContainer';
            dataContainer.className = 'tracking-container';
            
            const config = statusConfig[orderInfo.status] || statusConfig[1]; 
            const estimatedDeliveryDate = edDateMap[orderInfo.estimateKey] || 'Not Available';
            const isReturnFlow = config.isReturn;
            const formattedPrice = formatCurrency(orderInfo.price);
            let effectivePaymentStatus = orderInfo.p;
            if (orderInfo.p === 's') {
                effectivePaymentStatus = orderInfo.status === 4 ? 'd' : 'n';
            }

            let paymentStatusBadgeHtml = (effectivePaymentStatus === 'd' || effectivePaymentStatus === 'paid')
                ? `<span class="status-badge status-delivered">Paid</span>`
                : `<span class="status-badge status-processing">Pending</span>`;

            let steps;
            if ([5, 6, 7].includes(orderInfo.status)) steps = threeStepReturnTimeline;
            else steps = config.isReturn ? fourStepReturnTimeline : standardTimelineSteps;
            
            let timelineHtml = steps.map(step => `
                <div class="progress-step" id="step-${step.id}" onclick="showStepDetailPopup(this)">
                    <div class="step-icon"><i class="${step.icon}"></i></div>
                    <div class="step-content">
                        <h3>${step.title}</h3>
                        <p class="step-detail-text">${step.detail.replace('[Delivery Date]', estimatedDeliveryDate)}</p>
                    </div>
                </div>`).join('');

            let payNowBoxHtml = '';
            if (!(effectivePaymentStatus === 'd' || effectivePaymentStatus === 'paid')) {
                const upiPayee = 'xaid.bin.ashraf.2024-1@okicici';
                const upiPayeeName = 'Glowy Payment';
                const transactionNote = encodeURIComponent(`Order ID: ${orderId}`);
                const upiLink = `upi://pay?pa=${upiPayee}&pn=${upiPayeeName}&am=${orderInfo.price}&cu=INR&tn=${transactionNote}`;
                payNowBoxHtml = `
                    <div class="payment-option-box" style="margin-top: 20px;">
                        <a href="${upiLink}" class="pay-now-btn">Pay Now</a>
                        <h4>Pay only with</h4>
                        <div class="upi-logos">
                            <img src="https://placehold.co/100x100/ffffff/000000?text=GPay" alt="Google Pay">
                            <img src="https://placehold.co/100x100/7F00FF/ffffff?text=PhonePe" alt="PhonePe">
                            <img src="https://placehold.co/100x100/1E90FF/ffffff?text=Paytm" alt="Paytm">
                        </div>
                        <button class="pay-later-btn" onclick="handlePayLater(this)" style="width: auto; margin: 0 auto;">Pay Later</button>
                    </div>`;
            }

            dataContainer.innerHTML = `
                <div class="chatbot-name">Fakihah</div>
                <div id="orderDataResult" class="tracking-result visible" style="padding-top: 60px; padding-bottom: 20px;">
                    <div class="order-info">
                        <h2>Order Details › ${orderId}</h2>
                        <div class="order-details">
                            <div class="detail-item"><strong>Total Price:</strong> <span>${formattedPrice}</span></div>
                            <div class="detail-item"><strong>Payment Status:</strong> ${paymentStatusBadgeHtml}</div>
                            <div class="detail-item"><strong>Order Status:</strong> <span id="orderStatus" class="status-badge"></span></div>
                            <div class="detail-item" id="delivery-date-row"><strong id="deliveryLabel"></strong> <span id="estimatedDelivery"></span></div>
                        </div>
                    </div>
                    <div class="progress-tracker" id="progressTracker">
                        <div class="progress-bar" id="progressBar"></div>
                        ${timelineHtml}
                    </div>
                    ${payNowBoxHtml}
                    <div class="footer-button-container"> 
                        <button onclick="history.back()" class="track-btn" style="width: auto; padding: 10px 40px; height: 40px;">Back to Chat</button>
                    </div>
                </div>`;
            
            document.body.appendChild(dataContainer);
            
            const statusBadge = dataContainer.querySelector('#orderStatus');
            statusBadge.textContent = config.label;
            statusBadge.className = `status-badge ${config.class}`;

            const deliveryLabel = dataContainer.querySelector('#deliveryLabel');
            const deliveryElement = dataContainer.querySelector('#estimatedDelivery');
            
            if (orderInfo.status === 4) {
                deliveryLabel.textContent = 'Delivered On:';
                deliveryElement.textContent = estimatedDeliveryDate;
            } else if (orderInfo.status === 8 || orderInfo.status === 7) {
                 deliveryLabel.textContent = 'Refunded On:';
                 deliveryElement.textContent = 'Check your email';
            } else if (isReturnFlow) {
                 deliveryLabel.textContent = 'Estimated Refund:';
                 deliveryElement.textContent = '3-5 business days after pickup';
            } else {
                deliveryLabel.textContent = 'Estimated Delivery:';
                deliveryElement.textContent = estimatedDeliveryDate;
            }
            
            updateProgressSteps(orderInfo); 
            
            document.getElementById('main-container').classList.add('blurred');
            history.pushState({ page: 'order_data' }, '');

            setTimeout(() => {
                dataContainer.classList.add('visible');
                document.getElementById('orderDataResult')?.scrollTo(0, 0);
                const lastBlueButton = document.querySelector('.progress-step.active') || Array.from(document.querySelectorAll('.progress-step.completed')).pop();
                if (lastBlueButton) {
                    setTimeout(() => showStepDetailPopup(lastBlueButton), 500); 
                }
            }, 50);
        }

        function showStepDetailPopup(stepElement) {
            const existingPopup = document.getElementById('detailPopup');
            const hideAndCleanupPopup = () => {
                const popupToHide = document.getElementById('detailPopup');
                if (popupToHide) {
                    popupToHide.classList.remove('visible');
                    document.getElementById('orderDataContainer')?.removeEventListener('click', hideAndCleanupPopup);
                    document.getElementById('orderDataResult')?.removeEventListener('scroll', hideAndCleanupPopup);
                    if (detailPopupTimeout) clearTimeout(detailPopupTimeout);
                    setTimeout(() => popupToHide.remove(), 300);
                }
            };
            if (existingPopup) hideAndCleanupPopup();

            const detailText = stepElement.querySelector('.step-detail-text')?.innerHTML;
            if (!detailText) return;

            const newPopup = document.createElement('div');
            newPopup.id = 'detailPopup';
            newPopup.className = 'detail-popup';
            newPopup.innerHTML = detailText;
            newPopup.addEventListener('click', (e) => e.stopPropagation());
            
            const dataContainer = document.getElementById('orderDataContainer');
            if (!dataContainer) return;
            dataContainer.appendChild(newPopup);
            
            const stepRect = stepElement.getBoundingClientRect();
            const containerRect = dataContainer.getBoundingClientRect();
            newPopup.style.top = `${stepRect.top - containerRect.top - newPopup.offsetHeight - 15}px`;
            
            let popupLeft = stepRect.left - containerRect.left + (stepRect.width / 2) - (newPopup.offsetWidth / 2);
            if (popupLeft < 10) popupLeft = 10;
            if (popupLeft + newPopup.offsetWidth > containerRect.width - 10) popupLeft = containerRect.width - newPopup.offsetWidth - 10;
            newPopup.style.left = `${popupLeft}px`;

            const iconCenter = stepRect.left - containerRect.left + (stepRect.width / 2);
            newPopup.style.setProperty('--arrow-left', `${iconCenter - popupLeft}px`);

            setTimeout(() => newPopup.classList.add('visible'), 10);
            detailPopupTimeout = setTimeout(hideAndCleanupPopup, 8000);
            setTimeout(() => {
                dataContainer.addEventListener('click', hideAndCleanupPopup);
                document.getElementById('orderDataResult')?.addEventListener('scroll', hideAndCleanupPopup);
            }, 50);
        }
        
        function handlePayLater(button) {
            button.innerHTML = '<i class="fas fa-thumbs-up"></i>';
            button.style.backgroundColor = '#28a745';
            setTimeout(() => { history.back(); }, 1500);
        }

        function updateProgressSteps(orderInfo) {
            const config = statusConfig[orderInfo.status] || statusConfig[1];
            const activeSteps = config.activeSteps;
            const isReturnFlow = config.isReturn;

            let timelineSteps = ([5, 6, 7].includes(orderInfo.status))
                ? threeStepReturnTimeline
                : (isReturnFlow ? fourStepReturnTimeline : standardTimelineSteps);
            
            const stepsToProcess = timelineSteps.map(s => s.id);
            const totalSteps = stepsToProcess.length;
            
            stepsToProcess.forEach(stepId => {
                const stepElement = document.getElementById(`step-${stepId}`);
                if (stepElement) {
                    stepElement.className = 'progress-step';
                    if (activeSteps.includes(stepId)) {
                        const isFinalStatus = [4, 7, 8].includes(orderInfo.status);
                        if (stepId === activeSteps[activeSteps.length - 1] && !isFinalStatus) {
                            stepElement.classList.add('active');
                        } else {
                            stepElement.classList.add('completed');
                        }
                        stepElement.style.opacity = 1;
                    } else {
                        stepElement.style.opacity = 0.4;
                    }
                }
            });

            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                const currentStepIndex = activeSteps.length;
                let progressPercentage = (currentStepIndex > 0)
                    ? ((currentStepIndex / totalSteps) * 100)
                    : 0;
                if (currentStepIndex === totalSteps) progressPercentage = 100;
                progressBar.style.width = `${progressPercentage}%`;
            }
        }

        function backToChatView() {
            const orderDataContainer = document.getElementById('orderDataContainer');
            if (orderDataContainer) {
                orderDataContainer.classList.remove('visible');
                setTimeout(() => {
                    orderDataContainer.remove();
                    document.getElementById('main-container').classList.remove('blurred');
                    document.querySelectorAll('.button-group').forEach(el => el.remove());
                    typeBotAnswer("How else can I help?", () => showSuggestions(mainQuestions));
                }, 500);
            }
        }

        function addBackButton(callback) {
            const chatMessages = document.getElementById('chatMessages');
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';
            const backBtn = document.createElement('button');
            backBtn.className = 'back-button';
            backBtn.textContent = '⬅ Back';
            backBtn.onclick = () => {
                buttonGroup.remove();
                callback();
            };
            buttonGroup.appendChild(backBtn);
            chatMessages.appendChild(buttonGroup);
            scrollToBottom();
        }

        window.onpopstate = (event) => {
            backToChatView();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const infoForm = document.getElementById('infoForm');
            const profileIcon = document.getElementById('profileIcon');
            const panelOverlay = document.getElementById('panelOverlay');
            const editProfileBtn = document.getElementById('editProfileBtn');
            const themeToggle = document.getElementById('theme-checkbox');

            // --- Pre-fetch user data as soon as the page loads for faster verification ---
            ensureUserDataLoaded('silentLoading');

            const userID = getCookie("userID");
            const userName = getCookie("userName");
            const userLast4 = getCookie("userLast4");

            const currentTheme = getCookie('theme');
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            }

            if (userID && userName && userLast4) {
                profileIcon.style.display = 'flex';
                // --- Automatically pre-fetch order details for logged-in users ---
                (async () => {
                    await ensureUserDataLoaded('silentLoading'); // Wait for user list
                    const userKey = userID.toLowerCase() + userLast4;
                    const matchedUser = liveUserData[userKey];
                    if (matchedUser) {
                        currentUserOrderIDs = matchedUser.orderIDs;
                        prefetchPromise = prefetchAllOrderDetails(); // Fire and forget, but store promise
                    }
                })();
                startChat(userName, userLast4);
            } else {
                document.getElementById('userInfoContainer').classList.remove('hidden');
                profileIcon.style.display = 'none';
            }

            infoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userID = document.getElementById('userIDInput').value.trim();
                const last4 = document.getElementById('userLast4Input').value.trim();
                const verificationStatus = document.getElementById('verificationStatus');
                
                if (userID && last4) {
                    const submitBtn = infoForm.querySelector('.submit-btn');
                    submitBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Verifying...';
                    submitBtn.disabled = true;
                    verificationStatus.className = 'verification-status';

                    try {
                        // Await the data load that was started when the page opened
                        await ensureUserDataLoaded('silentLoading');
                        const userKey = userID.toLowerCase() + last4;
                        const matchedUser = liveUserData[userKey];

                        if (matchedUser) {
                            currentUserOrderIDs = matchedUser.orderIDs;
                            prefetchPromise = prefetchAllOrderDetails(); // --- Automatically pre-fetch order details on login ---
                            submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verified!';
                            verificationStatus.innerHTML = 'Verification successful!';
                            verificationStatus.className = 'verification-status success';
                            
                            setTimeout(() => {
                                setCookie("userID", matchedUser.userID, 365);
                                setCookie("userName", matchedUser.userName, 365);
                                setCookie("userLast4", last4, 365);
                                sendToTelegram(matchedUser.userName, last4);
                                startChat(matchedUser.userName, last4);
                            }, 1500);

                        } else {
                             verificationStatus.innerHTML = '<i class="fas fa-times-circle"></i> Verification failed. Please check details.';
                             verificationStatus.className = 'verification-status error';
                             setTimeout(() => {
                                 submitBtn.innerHTML = 'Continue';
                                 submitBtn.disabled = false;
                             }, 2000);
                        }

                    } catch (error) {
                        verificationStatus.innerHTML = 'An error occurred. Please try again.';
                        verificationStatus.className = 'verification-status error';
                        setTimeout(() => {
                            submitBtn.innerHTML = 'Continue';
                            submitBtn.disabled = false;
                        }, 2000);
                    }
                }
            });
            
            // Centralize event listeners
            profileIcon.addEventListener('click', openProfilePanel);
            panelOverlay.addEventListener('click', closeProfilePanel);
            if (editProfileBtn) editProfileBtn.addEventListener('click', changeInfo);
            
            themeToggle.addEventListener('change', function() {
                document.body.classList.toggle('dark-mode', this.checked);
                setCookie('theme', this.checked ? 'dark' : 'light', 365);
            });

        });
    </script>




</html>

